define(["jquery","jqueryui"],function(a){return{init:function(){function b(b){var c=b.attr("tabindex");c>0&&a(".section.main:visible").each(function(){a(this).attr("tabindex",c)})}function c(){a(document).keyup(function(b){var c=b.keyCode||b.which,d=a(":focus");13==c&&("undefined"!=typeof d.attr("id")&&d.attr("id").indexOf("tab")>-1&&d.click(),"undefined"!=typeof d.attr("id")&&d.attr("id").indexOf("section")>-1&&d.find(".toggler:visible").click())})}var d=function(b,c){console.log("single section in tab: using section name as tab name"),c.find(".toggle_closed").click();var d=c.find(".sectionname:not(.hidden)");if(a(".tabname_backup:visible").length>-1){var e=c.attr("aria-label");b.parent().append(b.clone().addClass("tabname_backup").hide()),b.html(e).addClass("tabsectionname"),0===a(".inplaceeditable").length?(d.hide(),c.find(".sectionhead").hide()):(d.addClass("edit_only"),c.find(".hidden.sectionname").hide(),c.find(".section-handle").hide())}};a(".section").on("updated",function(){var b=a(this).find(".inplaceeditable").attr("data-value");a(this).attr("aria-label",b),a(".tablink.active").click()});var e=function(a){var b=a.parent().find(".tabname_backup"),c=a.parent().find(".tabsectionname").removeClass("tabsectionname");c.html(b.html()),b.remove(),console.log("--> restoring section headline ")},f=function(){a(".tablink").on("click",function(){var c=a(this).attr("id"),f=a(this).attr("sections"),g=f.split(",");console.log("----");var h;a(this).find(".inplaceeditable-text")&&(h=a(this).find(".inplaceeditable-text").attr("data-value")),"undefined"==typeof h&&(h=a(this).html()),console.log('Clicked tab "'+h+'":'),a(".assessment_info_block_content").hide(),a(".tablink.active").removeClass("active"),a(".modulecontent").addClass("active"),a("#content_assessmentinformation_area").hide(),"tab_all"===c?a("li.section").show():"tab0"===c?(a("li.section").show(),a(".topictab").each(function(){a(this).attr("sections").length>0&&a.each(a(this).attr("sections").split(","),function(b,c){var d=a(".section[section-id='"+c+"']");d.hide(),d.hasClass("hidden")&&(d.addClass("hiding"),d.removeClass("hidden"))})})):"tab_assessment_information"===c?(console.log("Assessment Information tab clicked!"),a("li.section").hide(),a("li.section.hidden").addClass("hiding"),a("li.section.hiding").removeClass("hidden"),a("#content_assessmentinformation_area").show(),a(".merge_assessment_info").length>0&&(console.log("merging Assessment Info Block"),a(".assessment_info_block_content").show())):"tab_assessment_info_block"===c?(console.log("Assessment Info Block tab clicked!"),a("li.section").hide(),a("#changenumsections").hide(),a("li.section.hidden").addClass("hiding"),a("li.section.hiding").removeClass("hidden"),a(".assessment_info_block_content").show()):(a("#changenumsections").show(),a("li.section").hide(),a("li.section.hidden").addClass("hiding"),a("li.section.hiding").removeClass("hidden"),a.each(g,function(b,c){var d=a(".section[section-id='"+c+"']");d.show(),d.hasClass("hiding")&&(d.addClass("hidden"),d.removeClass("hiding"))})),a("#ontop_area #section-0").show();var i=a("li.section:visible").length,j=a("li.section.stealth:visible").length,l=a("#modulecontent").find(".block:visible"),m=a("#content_assessmentinformation_area:visible").length,n=a("li.section.hidden:visible").length,o=a("li.section.hiding:visible").length,p=o+n;if(a(".section0_ontop").length>0&&(console.log("section0 is on top - so reducing the number of visible sections for this tab by 1"),i--),console.log("number of visible sections: "+i),console.log("number of visible blocks: "+l.length),console.log("Assessment Info visible: "+m),console.log("number of stealth sections: "+j),console.log("number of hidden/hiding sections: "+n+" / "+o),console.log("no student sections: "+p),i<=p&&0===l.length&&0===m){console.log("This tab contains only hidden sections and will not be shown to students"),a(this).addClass("hidden-tab");var q=a(this);require(["core/str"],function(b){var d=b.get_string("hidden_tab_hint","format_qmulweeks");a.when(d).done(function(b){q.find("#not-shown-hint-"+c).remove();var d='<i id="not-shown-hint-'+c+'" class="fa fa-info" title="'+b+'"></i>';a(".tablink .fa-pencil").length>0?q.find(".inplaceeditable").append(d):q.append(d)})})}else a(this).removeClass("hidden-tab"),a("#not-shown-hint-"+c).remove();if(i<1&&0===l.length&&0===m){console.log("tab with no visible sections or blocks - hiding and resetting it"),a(this).parent().hide();var r=a("#courseid").attr("courseid"),s=a(this).attr("id").substring(3);a.ajax({url:"format/qmulweeks/ajax/update_tab_name.php",type:"POST",data:{courseid:r,tabid:c,tab_name:"Tab "+s},success:function(b){""!==b&&(console.log("Reset name of tab ID "+c+' to "'+b+'"'),a("[data-itemid="+b+"]").attr("data-value","Tab "+s).find(".quickeditlink").html("Tab "+s),k())}})}else console.log("tab with visible sections or blocks - showing it"),a(this).parent().show();var t=0,u=a("li.section:visible:not(.hidden)").first();a("#ontop_area").hasClass("section0_ontop")&&(t=1,u=a("li.section:visible:not(.hidden):eq(1)"));var v=u.attr("id");a(".single_section_tab").length>t&&(1===i&&"section-0"!==v&&"undefined"!=typeof v&&""!==a(this).find(".sectionname").html()?d(a(this),u):"off"===a("input[name='edit']").val()&&"section-0"!=v&&e(a(this))),b(a(this))})},g=function(){a(".tab_mover").on("click",function(){var b=a(this).attr("tabnr"),c=a(this).closest("li.section").attr("section-id"),d=a(this).parent().parent().parent().parent().parent().parent().parent().attr("id").substring(8);console.log("--> found section num: "+d);var f=a(".topictab.active").first().attr("id");"undefined"==typeof f&&(f="tab0"),console.log("----"),console.log("moving section "+c+' from tab "'+f+'" to tab nr '+b),a(".tablink").each(function(){a(this).attr("sections",a(this).attr("sections").replace(","+c,"")),a(this).attr("sections",a(this).attr("sections").replace(c+",","")),a(this).attr("sections",a(this).attr("sections").replace(c,"")),a(this).attr("section_nums",a(this).attr("section_nums").replace(","+d,"")),a(this).attr("section_nums",a(this).attr("section_nums").replace(d+",","")),a(this).attr("section_nums",a(this).attr("section_nums").replace(d,""))}),b>0&&(0===a("#tab"+b).attr("sections").length?a("#tab"+b).attr("sections",a("#tab"+b).attr("sections")+c):a("#tab"+b).attr("sections",a("#tab"+b).attr("sections")+","+c),0===a("#tab"+b).attr("section_nums").length?a("#tab"+b).attr("section_nums",a("#tab"+b).attr("section_nums")+d):(a("#tab"+b).attr("section_nums",a("#tab"+b).attr("section_nums")+","+d),console.log("---> section_nums: "+a("#tab"+b).attr("section_nums"))),a("#tab"+b).click(),a("#"+f).click()),e(a("#tab"+b));var g=a(".topictab:visible").length;if(console.log("visible tabs: "+g),0===a(".topictab:visible").length)console.log("NO tabs present - showing original content module tab"),a("#tab0").fadeOut(200),a(".modulecontentlink").fadeIn(1e3),a(".modulecontentlink").click();else{console.log("tabs present - hide original content module tab"),a(".modulecontentlink").fadeOut(500),a("#tab0").fadeIn(200),a("#"+f).click();var h=a("li.section:visible").length-(a("#ontop_area").hasClass("section0_ontop")?1:0);h>0&&a("li.section:visible").length>=h?(console.log("staying with the current tab (id = "+f+") as there are still "+a("li.section:visible").length+" sections left"),a("#tab"+b).click(),a("#"+f).click()):(console.log("no section in active tab id "+f+" left - hiding it and following section to new tab nr "+b),a("#tab"+b).click(),a("#"+f).parent().hide())}})},h=function(){a(".ontop_mover").on("click",function(){var b=a(".tablink.active");a("#ontop_area").append(a(this).closest(".section")),a("#ontop_area").addClass("section0_ontop"),b.click()})},i=function(){a(".inline_mover").on("click",function(){var b=a(this).closest(".section").attr("section-id");a("#inline_area").append(a(this).closest(".section")),a("#section-0").show(),a("#ontop_spacer").hide(),a(".section0_ontop").removeClass("section0_ontop"),a(".tablink").each(function(){if(a(this).attr("sections").indexOf(b)>-1)return a(".tablink").click(),a(this).click(),!1})})},j=function(){a(".menubar").on("click",function(){if(a(this).parent().parent().hasClass("section_action_menu")){var b=a(this).closest(".section").attr("id");a("#"+b+" .tab_mover").show();var c=[],d=[];if(a(".tablink").each(function(){if("undefined"!=typeof a(this).attr("id")){var b="",e=a(this).attr("id").substr(3);b=a(this).hasClass("tabsectionname")?a(this).html():a(this).find(".inplaceeditable").attr("data-value"),a.inArray(e,d)<0&&(a(this).hasClass("hidden-tab")&&(b=a(this).find("a").clone(),b.find("span.quickediticon").remove(),b=a.trim(b.html())),c[e]=b,d.push(e))}}),a(this).parent().find(".tab_mover").each(function(){var b=a(this).attr("tabnr");a(this).find(".menu-action-text").html('To Tab "'+c[b]+(c[b]==="Tab "+b||"0"===b?'"':'" (Tab '+b+")"))}),"section-0"===b)1===a("#ontop_area.section0_ontop").length?(a("#section-0 .inline_mover").show(),a("#section-0 .tab_mover").addClass("tab_mover_bak").removeClass("tab_mover").hide(),a("#section-0 .ontop_mover").hide()):(a("#section-0 .inline_mover").hide(),a("#section-0 .tab_mover_bak").addClass("tab_mover").removeClass("tab_mover_bak").show(),a("#section-0 .ontop_mover").show());else if("undefined"!=typeof a(".tablink.active").attr("id")){var e=a(".tablink.active").attr("id").substring(3);a("#"+b+' .tab_mover[tabnr="'+e+'"]').hide()}}})},k=function(){f(),g(),h(),i(),j(),c()},l=function(b,c){var d=c.draggable.find(".topictab").first(),e=a(this).find(".topictab").first(),f=c.draggable.find(".topictab").first().attr("id"),g=a(this).find(".topictab").first().attr("id");console.log('The tab with ID "'+f+'" was dropped onto tab with the ID "'+g+'"');var h=d.parent().html();d.parent().html(e.parent().html()),e.parent().html(h),k();var i="";a(".tablink").each(function(){var b=a(this).attr("id");void 0!==b&&(""===i?i=b:i.indexOf(b)===-1&&(i=i.concat(",").concat(b)))});var j=a(".topictab:visible").first().attr("sections").split(",")[0];"block_assessment_information"===j&&(j=a(".topictab:visible:eq(1)").attr("sections").split(",")[0]),a.ajax({url:"format/qmulweeks/ajax/update_tab_seq.php",type:"POST",data:{sectionid:j,tab_seq:i},success:function(a){console.log("the new tab sequence: "+a)}})};a(".modulecontentlink").click(function(){a(".assessment_info_block_content").hide(),a("li.section").show(),a("li.section.hiding").addClass("hidden"),a("li.section.hidden").removeClass("hiding")}),a("a").click(function(){if("#"!==a(this).attr("href")){var b=a(this).attr("href").split("#")[1];if("undefined"!=typeof b){var c=a("#"+b).attr("section-id"),d=!1;a(".tablink").each(function(){if(a(this).attr("sections").indexOf(c)>-1)return a(this).click(),d=!0,!1}),d||a("#tab0").click()}}}),a(document).ready(function(){console.log("--------------------------------------"),console.log("Beginning document tab initialization"),k(),a("#section-0 .right.side").show(),a(".tablink .fa-pencil").length>0&&(a(".topictab").parent().draggable({cursor:"move",stack:".qmultabitem",revert:!0}),a(".topictab").parent().droppable({accept:".qmultabitem",hoverClass:"hovered",drop:l})),(a("#tab_assessment_info_block").length>0||a(".merge_assessment_info").length>0)&&(console.log("===> Assessment Info Block tab present - showing the content_assessmentinformation_area"),a("#content_assessmentinformation_area").hide(),a("[sections=block_assessment_information]").parent().show(),a("#modulecontent").append(a(".block_assessment_information").addClass("assessment_info_block_content").hide()),a(".assessment_info_block_content").removeClass("d-flex"),a(".assessment_info_block_content").find(".card-body").removeClass("p-3").removeClass("card-body"),a(".assessment_info_block_content").find(".block-inner").removeClass("card"),a(".assessment_info_block_content").find(".show-content").hide(),0==a(".tablink .fa-pencil").length&&a(".assessment_info_block_content").find(".card-header").removeClass("d-flex").hide()),a("#tab0").click(),a(".tablink").click(),0===a(".topictab:visible").length?(a("#tab0").hide(),a(".modulecontentlink").show(),a(".modulecontentlink").click()):(a(".modulecontentlink").hide(),a(".tablink:visible").first().click()),a("#ontop_area").hasClass("section0_ontop")?(a("#section-0 .inline_mover").show(),a("#section-0 .tab_mover").hide(),a("#section-0 .ontop_mover").hide()):(a("#section-0 .inline_mover").hide(),a("#section-0 .tab_mover").show(),a("#section-0 .ontop_mover").show())})}}});